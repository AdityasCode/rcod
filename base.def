Bootstrap: docker
From: ubuntu:22.04

%post
    # Install prerequisites for micromamba and package building
    apt-get update && apt-get install -y wget bzip2 ca-certificates zstd curl

    # Download and install micromamba binary
    echo "--- Installing micromamba ---"
    cd /tmp
    
    # Download, extract, and move the binary to /usr/local/bin
    wget -qO- https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba --strip-components=1
    
    mv micromamba /usr/local/bin/micromamba
    chmod a+x /usr/local/bin/micromamba

    # Set up the root prefix (where envs will live)
    # This is lighter than a full conda install
    export MAMBA_ROOT_PREFIX=/opt/mamba
    mkdir -p $MAMBA_ROOT_PREFIX
    
    echo "--- Creating micromamba environment (this will be fast) ---"
    # Create the environment from the file
    # micromamba automatically sources its own activation scripts
    micromamba create -n rcod-env -f /app/requirements.yml -y
    
    # Clean up
    micromamba clean -afy
    
    # Make env readable by all users
    chmod -R a+rX $MAMBA_ROOT_PREFIX

    echo "--- Base image build complete ---"

%files
    /scratch/gilbreth/gandh105/rcod-build/requirements.yml /app/requirements.yml
    /scratch/gilbreth/gandh105/rcod-build/openood /app/openood

%environment
    # Micromamba env setup is slightly different
    export MAMBA_ROOT_PREFIX=/opt/mamba
    export MAMBA_EXE=/usr/local/bin/micromamba
    
    # Activate the rcod-env environment by default
    export PATH=$MAMBA_ROOT_PREFIX/envs/rcod-env/bin:$PATH
    export LD_LIBRARY_PATH=$MAMBA_ROOT_PREFIX/envs/rcod-env/lib:$LD_LIBRARY_PATH
    export PYTHONDONTWRITEBYTECODE=1
